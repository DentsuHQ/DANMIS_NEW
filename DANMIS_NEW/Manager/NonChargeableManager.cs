#pragma warning disable 1591
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Generated at 03/15/2021 18:33:57
//     Runtime Version: 4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using Utilities.Extensions;
using DANMIS_NEW.Interface;
using DANMIS_NEW.Models;
using DANMIS_NEW.ViewModel;
using DANMIS_NEW.ViewModel.ListResult;
using DANMIS_NEW.ViewModel.SearchModel;
using ResourceLibrary;

namespace DANMIS_NEW.Manager
{
    public class NonChargeableManager : INonChargeableManager
    {
        public static int year = Convert.ToInt32(DateTime.Now.Year.ToString().Substring(2, 2));

        readonly INonChargeableRepository _nonChargeableRepository;
        readonly IBrandDataRepository _brandDataRepository;
        public NonChargeableManager(INonChargeableRepository nonChargeableRepository, IBrandDataRepository brandDataRepository)
        {
            _nonChargeableRepository = nonChargeableRepository;
            _brandDataRepository = brandDataRepository;
        }

        /// <summary>
        /// 建立 NonChargeable
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public void Create(NonChargeableViewModel entity)
        {
            var item = (NonChargeable)entity;

            using (var transaction = _nonChargeableRepository.dbContext.Database.BeginTransaction())
            {
                try
                {
                    item.ImportType = "Manual";
                    item.RecordStatus = "New";
                    item.ProjectID = GetNewProjectID(entity.BrandName);
                    item.MediaType = ConvertMediaType(item.MediaType);
                    item.ProjectStatus = ConvertProjectStatus(item.ProjectStatus);
                    item.ProjectType = ConvertProjectType(item.ProjectType);
                    item.Chargeable = ConvertChargeable(item.Chargeable);
                    item.CompareDate = DateTime.Now;
                    item.ImportDate = DateTime.Now;
                    item.UploadDate = DateTime.Now;
                    _nonChargeableRepository.Create(item);
                    transaction.Commit();
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }
        }

        /// <summary>
        /// 根據 id 刪除 NonChargeable
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public void Delete(List<Guid> id)
        {
            using (var transaction = _nonChargeableRepository.dbContext.Database.BeginTransaction())
            {
                try
                {
                    var itemSet = _nonChargeableRepository.Where(x => id.Contains(x.ID)).ToList();
                    if (itemSet.Any())
                    {
                        foreach (var item in itemSet)
                        {
                            _nonChargeableRepository.Delete(item);
                        }
                    }
                    transaction.Commit();
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }
        }

        /// <summary>
        /// 根據 id 取得 NonChargeable
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public NonChargeableViewModel GetByID(Guid id)
        {
            var item = _nonChargeableRepository.GetByID(id);
            item.MediaType = ConvertMediaType(item.MediaType);
            item.ProjectStatus = ConvertProjectStatus(item.ProjectStatus);
            item.ProjectType = ConvertProjectType(item.ProjectType);
            item.Chargeable = ConvertChargeable(item.Chargeable);
            var result = (NonChargeableViewModel)item;

            return result;
        }

        /// <summary>
        /// 分頁
        /// </summary>
        /// <param name="searchModel"></param>
        /// <returns></returns>
        public Paging<NonChargeableListResult> Paging(NonChargeableSearchModel searchModel)
        {
            var isChargeable = ConvertChargeable(searchModel.IsChargeable);
            var projectStatus = ConvertProjectStatus(searchModel.Status);
            var projectType = ConvertProjectType(searchModel.ProjectType);

            // 預設集合
            var temp = _nonChargeableRepository.GetAll();

            // 將 DB 資料轉換為列表頁呈現資料
            var tempResult = from x in temp
                             select new NonChargeableListResult
                             {
                                 SequenceNo = x.SequenceNo,
                                 ID = x.ID,
                                 WORK_CARD_NO = x.WORK_CARD_NO,
                                 ProjectName = x.ProjectName,
                                 StartDate = x.StartDate,
                                 CompleteDate = x.CompleteDate,
                                 ProjectStatus = x.ProjectStatus,
                                 ProjectOwnerID = x.ProjectOwnerID,
                                 OwnerEmail = x.OwnerEmail,
                                 PortfolioName = x.PortfolioName,
                                 PortfolioOwnerID = x.PortfolioOwnerID,
                                 ProgramName = x.ProgramName,
                                 ProgramOwnerID = x.ProgramOwnerID,
                                 CurrencyINR = x.CurrencyINR,
                                 Budget = x.Budget,
                                 Benefit = x.Benefit,
                                 ClientName = x.ClientName,
                                 LineofBusiness = x.LineofBusiness,
                                 Region = x.Region,
                                 BrandName = x.BrandName,
                                 Market = x.Market,
                                 Office = x.Office,
                                 Chargeable = x.Chargeable,
                                 Commission = x.Commission,
                                 GroupName = x.GroupName,
                                 AccProjID = x.AccProjID,
                                 LegalEntity = x.LegalEntity,
                                 FinSourSys = x.FinSourSys,
                                 CRMURNID = x.CRMURNID,
                                 CRMSourSys = x.CRMSourSys,
                                 OtherSource = x.OtherSource,
                                 AdditionalProjectID = x.AdditionalProjectID,
                                 RecordStatus = x.RecordStatus,
                                 ImportDate = x.ImportDate,
                                 UploadDate = x.UploadDate,
                                 ImportUniqNo = x.ImportUniqNo,
                                 ImportLocName = x.ImportLocName,
                                 ImportEngName = x.ImportEngName,
                                 UploadUniqNo = x.UploadUniqNo,
                                 UploadLocName = x.UploadLocName,
                                 UploadEngName = x.UploadEngName,
                                 CompareDate = x.CompareDate,
                                 CompareUniqNo = x.CompareUniqNo,
                                 CompareLocName = x.CompareLocName,
                                 CompareEngName = x.CompareEngName,
                                 ImportType = x.ImportType,
                                 ProjectID = x.ProjectID,
                                 MediaType = x.MediaType,
                                 ProjectType = x.ProjectType,
                             };

            #region 篩選
            // 如有篩選條件，進行篩選
            if (!string.IsNullOrWhiteSpace(searchModel.Search))
            {
                var search = searchModel.Search.ToLower();
                tempResult = tempResult.Where(x =>
                    x.ProjectName.Contains(search) ||
                    x.StartDate.Contains(search) ||
                    x.CompleteDate.Contains(search) ||
                    x.ProjectStatus.Contains(search) ||
                    x.ProjectOwnerID.Contains(search) ||
                    x.OwnerEmail.Contains(search) ||
                    x.PortfolioName.Contains(search) ||
                    x.PortfolioOwnerID.Contains(search) ||
                    x.ProgramName.Contains(search) ||
                    x.ProgramOwnerID.Contains(search) ||
                    x.CurrencyINR.Contains(search) ||
                    x.Budget.Contains(search) ||
                    x.Benefit.Contains(search) ||
                    x.ClientName.Contains(search) ||
                    x.LineofBusiness.Contains(search) ||
                    x.Region.Contains(search) ||
                    x.BrandName.Contains(search) ||
                    x.Market.Contains(search) ||
                    x.Office.Contains(search) ||
                    x.Chargeable.Contains(search) ||
                    x.Commission.Contains(search) ||
                    x.GroupName.Contains(search) ||
                    x.AccProjID.Contains(search) ||
                    x.LegalEntity.Contains(search) ||
                    x.FinSourSys.Contains(search) ||
                    x.CRMURNID.Contains(search) ||
                    x.CRMSourSys.Contains(search) ||
                    x.OtherSource.Contains(search) ||
                    x.AdditionalProjectID.Contains(search) ||
                    x.RecordStatus.Contains(search) ||
                    x.ImportLocName.Contains(search) ||
                    x.ImportEngName.Contains(search) ||
                    x.UploadLocName.Contains(search) ||
                    x.UploadEngName.Contains(search) ||
                    x.CompareLocName.Contains(search) ||
                    x.CompareEngName.Contains(search) ||
                    false);
            }
            if (searchModel.StartDate != null)
            {
                var searchEndDate = searchModel.StartDate.HasValue ? searchModel.StartDate.Value.AddDays(1) : new DateTime();
                tempResult = tempResult.Where(x =>
                    (x.ImportDate >= searchModel.StartDate && x.ImportDate  <= searchEndDate)||
                    false);
            }
            if (!string.IsNullOrWhiteSpace(isChargeable))
                tempResult = tempResult.Where(x =>
                    x.Chargeable == isChargeable ||
                    false);
            if (!string.IsNullOrWhiteSpace(projectStatus))
                tempResult = tempResult.Where(x =>
                    x.ProjectStatus == projectStatus ||
                    false);
            if (!string.IsNullOrWhiteSpace(projectType))
                tempResult = tempResult.Where(x =>
                    x.ProjectType == projectType ||
                    false);
            #endregion

            // 進行分頁處理
            var result = new Paging<NonChargeableListResult>();
            result.total = tempResult.Count();
            result.rows = tempResult
                .OrderBy(searchModel.Sort, searchModel.Order)
                .Skip(searchModel.Offset)
                .Take(searchModel.Limit)
                .ToList();

            return result;
        }

        /// <summary>
        /// 更新 NonChargeable
        /// </summary>
        /// <param name="entity"></param>
        public void Update(NonChargeableViewModel entity)
        {
            using (var transaction = _nonChargeableRepository.dbContext.Database.BeginTransaction())
            {
                try
                {
                    var source = _nonChargeableRepository.GetByID(entity.ID);
                    source.ProjectName = entity.ProjectName ?? string.Empty;
                    source.StartDate = entity.StartDate ?? string.Empty;
                    source.CompleteDate = entity.CompleteDate ?? string.Empty;
                    source.Description = entity.Description ?? string.Empty;
                    source.ProjectStatus = ConvertProjectStatus(entity.ProjectStatus);
                    source.ProjectOwnerID = entity.ProjectOwnerID ?? string.Empty;
                    source.OwnerEmail = entity.OwnerEmail ?? string.Empty;
                    source.PortfolioName = entity.PortfolioName ?? string.Empty;
                    source.PortfolioOwnerID = entity.PortfolioOwnerID ?? string.Empty;
                    source.ProgramName = entity.ProgramName ?? string.Empty;
                    source.ProgramOwnerID = entity.ProgramOwnerID ?? string.Empty;
                    source.CurrencyINR = entity.CurrencyINR ?? string.Empty;
                    source.Budget = entity.Budget ?? string.Empty;
                    source.Benefit = entity.Benefit ?? string.Empty;
                    source.ClientName = entity.ClientName ?? string.Empty;
                    source.LineofBusiness = entity.LineofBusiness ?? string.Empty;
                    source.Region = entity.Region ?? string.Empty;
                    source.BrandName = entity.BrandName ?? string.Empty;
                    source.Market = entity.Market ?? string.Empty;
                    source.Office = entity.Office ?? string.Empty;
                    source.Chargeable = ConvertChargeable(entity.Chargeable);
                    source.Commission = entity.Commission ?? string.Empty;
                    source.GroupName = entity.GroupName ?? string.Empty;
                    source.AccProjID = entity.AccProjID ?? string.Empty;
                    source.LegalEntity = entity.LegalEntity ?? string.Empty;
                    source.FinSourSys = entity.FinSourSys ?? string.Empty;
                    source.CRMURNID = entity.CRMURNID ?? string.Empty;
                    source.CRMSourSys = entity.CRMSourSys ?? string.Empty;
                    source.OtherSource = entity.OtherSource ?? string.Empty;
                    source.AdditionalProjectID = entity.AdditionalProjectID ?? string.Empty;
                    source.RecordStatus = entity.RecordStatus ?? string.Empty;
                    source.ImportDate = entity.ImportDate;
                    source.UploadDate = DateTime.Now;
                    source.ImportUniqNo = entity.ImportUniqNo;
                    source.ImportLocName = entity.ImportLocName ?? string.Empty;
                    source.ImportEngName = entity.ImportEngName ?? string.Empty;
                    source.UploadUniqNo = entity.UploadUniqNo;
                    source.UploadLocName = entity.UploadLocName ?? string.Empty;
                    source.UploadEngName = entity.UploadEngName ?? string.Empty;
                    source.CompareDate = entity.CompareDate;
                    source.CompareUniqNo = entity.CompareUniqNo;
                    source.CompareLocName = entity.CompareLocName ?? string.Empty;
                    source.CompareEngName = entity.CompareEngName ?? string.Empty;
                    source.MediaType = ConvertMediaType(entity.MediaType);
                    source.ProjectType = ConvertProjectType(entity.ProjectType);

                    _nonChargeableRepository.Update(source);
                    transaction.Commit();
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }
        }

        #region 取得新 ProjectID
        public string GetNewProjectID(string brandName)
        {
            var brandData = _brandDataRepository.GetAll().FirstOrDefault(x => x.BrandName == brandName);
            var brandShortName = GetBrandShortName(brandName);
            // 下一年更新年分從0重新開始排編號
            if (brandData.Year != year)
            {
                brandData.Year = year;
                brandData.SeqNo = 0;
            }
            brandData.SeqNo = brandData.SeqNo + 1;
            var seqNo = brandData.SeqNo.ToString().PadLeft(4, '0');
            var result = string.Concat(brandShortName, year, seqNo);
            _brandDataRepository.Update(brandData);
            return result;
        }
        #endregion

        #region 取得 ProjectID 短名
        public string GetBrandShortName(string brandName)
        {
            string sResult = "";

            switch (brandName)
            {
                case "Dentsu One":
                    sResult = "DO";
                    break;
                case "iProspect":
                    sResult = "Ip";
                    break;
                default:
                    sResult = brandName;
                    break;
            }

            return sResult;
        }
        #endregion

        #region ConvertMediaType
        public string ConvertMediaType(string mediaType)
        {
            string sResult = "";

            switch (mediaType)
            {
                case "電視":
                    sResult = "0";
                    break;
                case "報紙":
                    sResult = "1";
                    break;
                case "雜誌":
                    sResult = "2";
                    break;
                case "廣播":
                    sResult = "3";
                    break;
                case "網路":
                    sResult = "4";
                    break;
                case "其他":
                    sResult = "5";
                    break;
                case "Plan":
                    sResult = "6";
                    break;
                case "0":
                    sResult = "電視";
                    break;
                case "1":
                    sResult = "報紙";
                    break;
                case "2":
                    sResult = "雜誌";
                    break;
                case "3":
                    sResult = "廣播";
                    break;
                case "4":
                    sResult = "網路";
                    break;
                case "5":
                    sResult = "其他";
                    break;
                case "6":
                    sResult = "Plan";
                    break;
                default:
                    sResult = string.Empty;
                    break;
            }

            return sResult;
        }
        #endregion

        #region ConvertProjectStatus
        public string ConvertProjectStatus(string projectStatus)
        {
            string sResult = "";

            switch (projectStatus)
            {
                case "CUR":
                    sResult = "0";
                    break;
                case "CPL":
                    sResult = "1";
                    break;
                case "0":
                    sResult = "CUR";
                    break;
                case "1":
                    sResult = "CPL";
                    break;
                default:
                    sResult = string.Empty;
                    break;
            }

            return sResult;
        }
        #endregion

        #region ConvertProjectType
        public string ConvertProjectType(string projectType)
        {
            string sResult = "";

            switch (projectType)
            {
                case "Retainer":
                    sResult = "0";
                    break;
                case "Project Statement of Work":
                    sResult = "1";
                    break;
                case "Commission":
                    sResult = "2";
                    break;
                case "Time and Materials":
                    sResult = "3";
                    break;
                case "Internal":
                    sResult = "4";
                    break;
                case "0":
                    sResult = "Retainer";
                    break;
                case "1":
                    sResult = "Project Statement of Work";
                    break;
                case "2":
                    sResult = "Commission";
                    break;
                case "3":
                    sResult = "Time and Materials";
                    break;
                case "4":
                    sResult = "Internal";
                    break;
                default:
                    sResult = string.Empty;
                    break;
            }

            return sResult;
        }
        #endregion

        #region ConvertChargeable
        public string ConvertChargeable(string chargeable)
        {
            string sResult = "";

            switch (chargeable)
            {
                case "Chargeable":
                    sResult = "0";
                    break;
                case "Non-Chargeable":
                    sResult = "1";
                    break;
                case "0":
                    sResult = "Chargeable";
                    break;
                case "1":
                    sResult = "Non-Chargeable";
                    break;
                default:
                    sResult = string.Empty;
                    break;
            }

            return sResult;
        }
        #endregion
    }
}
#pragma warning restore 1591